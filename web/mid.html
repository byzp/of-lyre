<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI ç®¡ç†é¡µ</title>
    <style>
        /* CSS å˜é‡å®šä¹‰ */
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f6f7fb;
            --card-bg: #fff;
            --border-color: #e9ecef;
            --text-primary: #333;
            --text-secondary: #666;
            --shadow: 0 2px 6px rgba(0,0,0,0.1);
            --border-radius: 6px;
            --table-header-bg: #f0f0f0;
        }

        /* å…¨å±€æ ·å¼ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background: var(--bg-color);
            padding: 20px;
            color: var(--text-primary);
        }

        /* è¯­è¨€åˆ‡æ¢å™¨ */
        .language-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 5px;
        }

        .language-switcher button {
            padding: 6px 10px;
            font-size: 12px;
            border: 1px solid var(--border-color);
            background: white;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            position: relative;
        }

        .language-switcher button:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .language-switcher button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-width: 120px;
            display: none;
            z-index: 1001;
        }

        .language-dropdown.show {
            display: block;
        }

        .language-dropdown button {
            width: 100%;
            text-align: left;
            border: none;
            border-bottom: 1px solid var(--border-color);
            background: transparent;
            padding: 8px 12px;
            font-size: 13px;
        }

        .language-dropdown button:last-child {
            border-bottom: none;
        }

        /* æ ‡ç­¾é¡µå®¹å™¨ */
        .tab-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* æ ‡ç­¾é¡µå¯¼èˆª */
        .tab-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-nav button {
            flex: 1;
            padding: 12px;
            border: none;
            border-bottom: 2px solid transparent;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            margin-bottom: -1px;
        }

        .tab-nav button.active {
            background: var(--card-bg);
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: bold;
        }

        .tab-nav button:hover:not(.active) {
            background: #e9ecef;
        }

        /* æ ‡ç­¾é¡µå†…å®¹ */
        .tab-content {
            padding: 20px;
        }

        /* ç•™è¨€æ¿æ ‡ç­¾é¡µç‰¹æ®Šæ ·å¼ - ç§»é™¤å†…è¾¹è·é™åˆ¶ */
        .tab-content #comments {
            padding: 0;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* è¡¨å•å…ƒç´  */
        input, button {
            padding: 8px 12px;
            margin: 8px 0;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            cursor: pointer;
            background: var(--primary-color);
            color: white;
            border: none;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background: #357abd;
        }

        /* ä¸Šä¼ è¡¨å• */
        #upload-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            padding: 0 20px;
            box-sizing: border-box;
        }

        /* æœç´¢æ ‡ç­¾é¡µå†…å®¹ */
        #search {
            padding: 0;
        }

        /* æœç´¢åŒºåŸŸ */
        #search-area {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 0 20px;
            justify-content: center;
            width: 100%;
            box-sizing: border-box;
        }

        /* æœç´¢è¾“å…¥æ¡†æ‹‰ä¼¸ */
        #search-area input {
            flex-grow: 1;
            width: 100%;
        }

        /* æœç´¢æŒ‰é’®å›ºå®šå®½åº¦ */
        #search-area button {
            white-space: nowrap;
            min-width: 60px;
        }

        /* æœç´¢ç»“æœ */
        #search_results {
            margin: 0;
            text-align: left;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-top: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px;
            text-align: left;
            white-space: nowrap;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--table-header-bg);
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: bold;
        }

        /* æœç´¢ç»“æœè¡¨æ ¼åˆ—æ ·å¼ï¼ˆ5åˆ—ï¼šåç§°ã€ä¸Šä¼ è€…ã€ç½®ä¿¡åº¦ã€ä¸Šä¼ æ—¶é—´ã€æ“ä½œï¼‰ */
        #search_results .table-container table th,
        #search_results .table-container table td {
            white-space: nowrap;
        }

        /* æ“ä½œæŒ‰é’® */
        .actions {
            display: flex;
            gap: 5px;
        }

        .actions button {
            padding: 4px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        /* åˆ é™¤æŒ‰é’®æ ·å¼ */
        .actions button:first-child {
            background: #f44336;
            color: white;
        }

        /* æ’­æ”¾æŒ‰é’®æ ·å¼ */
        .actions button.play {
            background: #2196F3;
            color: white;
        }

        /* ä¸‹è½½æŒ‰é’®æ ·å¼ */
        .actions button:last-child {
            background: #4CAF50;
            color: white;
        }

        /* æŒ‰é’®æ‚¬åœæ•ˆæœ */
        .actions button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* çŠ¶æ€æç¤º */
        .small {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .loading-indicator, .end-indicator {
            text-align: center;
            padding: 10px;
            font-size: 13px;
        }

        .loading-indicator {
            color: var(--text-secondary);
        }

        /* å…¨å±€æ»šåŠ¨æ¡ä¼˜åŒ– */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Firefoxæ»šåŠ¨æ¡ä¼˜åŒ– */
        :root {
            scrollbar-width: 12px;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }

        .end-indicator {
            color: #999;
        }

        /* ç•™è¨€æ¿æ ·å¼ */
        .comment-form {
            width: 100%;
            margin: 0 0 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .comment-form h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .comment-form input,
        .comment-form textarea {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
        }

        .comment-form textarea {
            resize: vertical;
            min-height: 80px;
        }

        .comment-form button {
            width: 100%;
            padding: 8px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .comment-form button:hover {
            opacity: 0.9;
        }

        .comment-item {
            width: 100%;
            margin: 0 0 15px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: white;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .comment-author {
            font-weight: bold;
            color: var(--primary-color);
        }

        .comment-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .comment-content {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .comment-actions {
            text-align: right;
        }

        .comment-actions button {
            padding: 4px 12px;
            font-size: 12px;
            background: var(--danger-color, #f44336);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .comment-actions button:hover {
            opacity: 0.9;
        }

        /* é¡µè„š */
        footer {
            text-align: center;
            margin-top: 20px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* éŸ³é¢‘æ’­æ”¾å™¨æ ·å¼ */
        .audio-player {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            padding: 20px;
            z-index: 1000;
            min-width: 400px;
            max-width: 600px;
        }

        .audio-player.active {
            display: block;
        }

        .audio-player h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .player-controls {
            margin-bottom: 15px;
        }

        .audio-player audio {
            width: 100%;
            margin-bottom: 15px;
        }

        .progress-container {
            width: 100%;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            margin-bottom: 10px;
            position: relative;
            cursor: pointer;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s ease-out;
            position: relative;
        }

        .progress-bar.dragging {
            transition: none;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -6px;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .progress-bar:active::after {
            cursor: grabbing;
        }



        .time-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .player-actions {
            display: flex;
            gap: 10px;
        }

        .player-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .close-button {
            background: #f44336;
            color: white;
        }

        .close-button:hover {
            background: #d32f2f;
        }

        /* èƒŒæ™¯é®ç½© */
        .player-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .player-overlay.active {
            display: block;
        }

        /* ç­‰å¾…æç¤ºæ ·å¼ */
        .waiting-message {
            text-align: center;
            padding: 40px;
        }

        .waiting-message .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- è¯­è¨€åˆ‡æ¢å™¨ -->
    <div class="language-switcher">
        <button id="currentLangBtn" onclick="language.showDropdown()">ğŸŒ è¯­è¨€</button>
        <div id="languageDropdown" class="language-dropdown">
            <button onclick="language.switch('zh')">ä¸­æ–‡</button>
            <button onclick="language.switch('en')">English</button>
            <button onclick="language.switch('ja')">æ—¥æœ¬èª</button>
            <button onclick="language.switch('vi')">Tiáº¿ng Viá»‡t</button>
            <button onclick="language.switch('ko')">í•œêµ­ì–´</button>
        </div>
    </div>

    <div class="tab-container">
        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
            <div class="tab-nav">
                <button class="active" onclick="midiApp.switchTab('upload', event)" data-key="upload-midi">ä¸Šä¼  MIDI</button>
                <button onclick="midiApp.switchTab('search', event)" data-key="search-songs">æœç´¢æ­Œæ›²</button>
                <button onclick="midiApp.switchTab('list', event)" data-key="latest-uploads">æœ€æ–°ä¸Šä¼ </button>
                <button onclick="midiApp.switchTab('comments', event)" data-key="message-board">ç•™è¨€æ¿</button>
            </div>

        <!-- æ ‡ç­¾é¡µå†…å®¹ -->
        <div class="tab-content">
            <!-- ä¸Šä¼ æ ‡ç­¾é¡µ -->
            <div id="upload" class="tab-panel active">
                <form id="upload-form">
                    <input type="file" id="file" accept=".mid,.midi">
                    <input type="text" id="upload_by" placeholder="ä¸Šä¼ è€…åç§°" data-placeholder-key="uploader-name" required>
                    <input type="password" id="delete_password" placeholder="åˆ é™¤æ—¶éœ€è¦çš„å¯†ç " data-placeholder-key="delete-password" required>
                    <button type="button" onclick="midiApp.upload()" data-key="upload">ä¸Šä¼ </button>
                    <p id="upload_result" class="small"></p>
                </form>
            </div>

            <!-- æœç´¢æ ‡ç­¾é¡µ -->
            <div id="search" class="tab-panel">
                <div id="search-area">
                    <input type="text" id="search_name" placeholder="æ­Œæ›²åï¼ˆæ”¯æŒæ¨¡ç³Š / * éšæœºï¼‰" data-placeholder-key="search-placeholder">
                    <button onclick="midiApp.search()" data-key="search">æœç´¢</button>
                </div>
                <div id="search_results"></div>
            </div>

            <!-- åˆ—è¡¨æ ‡ç­¾é¡µ -->
            <div id="list" class="tab-panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span data-key="latest-uploads-header">æœ€æ–°ä¸Šä¼ </span>
                    <button onclick="midiApp.refreshList()" data-key="refresh">åˆ·æ–°</button>
                </div>
                <div class="table-container" id="table_container">
                    <table>
                        <thead>
                            <tr>
                                <th data-key="name">åç§°</th>
                                <th data-key="uploader">ä¸Šä¼ è€…</th>
                                <th data-key="duration">æ—¶é•¿</th>
                                <th data-key="size">å¤§å°</th>
                                <th data-key="upload-time">ä¸Šä¼ æ—¶é—´</th>
                                <th data-key="actions">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="latest_list"></tbody>
                    </table>
                    <div id="loading" class="loading-indicator" style="display:none;" data-key="loading">åŠ è½½ä¸­...</div>
                    <div id="end" class="end-indicator" style="display:none;" data-key="no-more-data">æ²¡æœ‰æ›´å¤šæ•°æ®</div>
                </div>
            </div>
            
            <!-- ç•™è¨€æ¿æ ‡ç­¾é¡µ -->
            <div id="comments" class="tab-panel">
                <!-- æ·»åŠ ç•™è¨€è¡¨å• -->
                <div id="add-comment-form" class="comment-form">
                    <h4 data-key="message">ç•™è¨€</h4>
                    <form id="comment-form">
                        <input type="text" id="comment_name" placeholder="æ‚¨çš„æ˜µç§°" data-placeholder-key="nickname" required>
                        <textarea id="comment_content" placeholder="è¯·è¾“å…¥ç•™è¨€å†…å®¹" data-placeholder-key="message-content" rows="4" required></textarea>
                        <button type="button" onclick="midiApp.addComment()" data-key="submit-message">æäº¤ç•™è¨€</button>
                    </form>
                </div>

                <!-- åˆ·æ–°æŒ‰é’® -->
                <button onclick="midiApp.loadComments()" style="margin: 0 20px 10px; padding: 4px 12px; float: right;" data-key="refresh-comments">åˆ·æ–°</button>
                <div style="clear: both;"></div>

                <!-- ç•™è¨€åˆ—è¡¨ -->
                <div id="comments_list"></div>
            </div>
        </div>
    </div>

    <!-- éŸ³é¢‘æ’­æ”¾å™¨é®ç½© -->
    <div class="player-overlay" id="playerOverlay" onclick="audioPlayer.close()"></div>

    <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
    <div class="audio-player" id="audioPlayer">
        <h3 id="playerTitle" data-key="now-playing">æ­£åœ¨æ’­æ”¾</h3>
            <div class="player-controls">
            <audio id="audioElement" preload="metadata"></audio>
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="time-info">
                <span id="currentTime">0:00</span>
                <span id="duration">0:00</span>
            </div>
        </div>
        <div class="player-actions">
            <button id="playPauseButton" onclick="audioPlayer.togglePlayPause()" disabled data-key="loading">åŠ è½½ä¸­...</button>
            <button class="close-button" onclick="audioPlayer.close()" data-key="close">å…³é—­</button>
        </div>
    </div>

    <!-- ç­‰å¾…æç¤º -->
    <div class="audio-player" id="waitingPlayer">
        <div class="waiting-message">
            <div class="spinner"></div>
            <p data-key="generating-audio">æ­£åœ¨ç”ŸæˆéŸ³é¢‘ï¼Œè¯·ç¨å€™...</p>
        </div>
    </div>

    <footer>
        <a href="https://github.com/byzp/of-lyre/tree/main/web" target="_blank" data-key="about-api">æœ‰å…³æ­¤ API</a>
    </footer>

<script>
// å¤šè¯­è¨€æ”¯æŒ
const language = {
    // å½“å‰è¯­è¨€
    currentLang: 'en',

    // æ”¯æŒçš„è¯­è¨€åˆ—è¡¨
    supportedLangs: ['zh', 'en', 'ja', 'vi', 'ko'],

    // ç¿»è¯‘å¯¹è±¡
    translations: {
        zh: {
            title: 'MIDI ç®¡ç†é¡µ',
            'upload-midi': 'ä¸Šä¼  MIDI',
            'search-songs': 'æœç´¢æ­Œæ›²',
            'latest-uploads': 'æœ€æ–°ä¸Šä¼ ',
            'message-board': 'ç•™è¨€æ¿',
            'upload': 'ä¸Šä¼ ',
            'uploader-name': 'ä¸Šä¼ è€…åç§°',
            'delete-password': 'åˆ é™¤æ—¶éœ€è¦çš„å¯†ç ',
            'upload-result': '',
            'search-placeholder': 'æ­Œæ›²åï¼ˆæ”¯æŒæ¨¡ç³Š / * éšæœºï¼‰',
            'search': 'æœç´¢',
            'latest-uploads-header': 'æœ€æ–°ä¸Šä¼ ',
            'refresh': 'åˆ·æ–°',
            'name': 'åç§°',
            'uploader': 'ä¸Šä¼ è€…',
            'duration': 'æ—¶é•¿',
            'size': 'å¤§å°',
            'upload-time': 'ä¸Šä¼ æ—¶é—´',
            'actions': 'æ“ä½œ',
            'confidence': 'ç½®ä¿¡åº¦',
            'delete': 'åˆ é™¤',
            'play': 'è¯•å¬',
            'download': 'ä¸‹è½½',
            'loading': 'åŠ è½½ä¸­...',
            'no-more-data': 'æ²¡æœ‰æ›´å¤šæ•°æ®',
            'please-select-file': 'è¯·é€‰æ‹©MIDIæ–‡ä»¶',
            'upload-success': 'ä¸Šä¼ å®Œæˆ',
            'upload-failed': 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•',
            'please-enter-search': 'è¯·è¾“å…¥æœç´¢å…³é”®è¯',
            'no-results': 'æ²¡æœ‰æ‰¾åˆ°ç»“æœ',
            'search-failed': 'æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•',
            'confirm-delete': 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªéŸ³ä¹æ–‡ä»¶å—ï¼Ÿ',
            'please-enter-delete-password': 'è¯·è¾“å…¥åˆ é™¤å¯†ç ',
            'delete-success': 'åˆ é™¤æˆåŠŸ',
            'delete-failed': 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•',
            'message': 'ç•™è¨€',
            'nickname': 'æ‚¨çš„æ˜µç§°',
            'message-content': 'è¯·è¾“å…¥ç•™è¨€å†…å®¹',
            'submit-message': 'æäº¤ç•™è¨€',
            'refresh-comments': 'åˆ·æ–°',
            'no-comments': 'æš‚æ— ç•™è¨€',
            'message-add-success': 'ç•™è¨€æ·»åŠ æˆåŠŸ',
            'message-add-failed': 'ç•™è¨€æ·»åŠ å¤±è´¥',
            'please-fill-message': 'è¯·å¡«å†™å®Œæ•´çš„ç•™è¨€ä¿¡æ¯',
            'message-delete-success': 'ç•™è¨€åˆ é™¤æˆåŠŸ',
            'message-delete-failed': 'ç•™è¨€åˆ é™¤å¤±è´¥',
            'confirm-delete-message': 'ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ',
            'now-playing': 'æ­£åœ¨è¯•å¬',
            'close': 'å…³é—­',
            'generating-audio': 'æ­£åœ¨ç”ŸæˆéŸ³é¢‘ï¼Œè¯·ç¨å€™...',
            'start-playing': 'å¼€å§‹æ’­æ”¾',
            'play-failed': 'æ’­æ”¾å¤±è´¥ï¼Œè¯·é‡è¯•',
            'audio-load-failed': 'éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•',
            'audio-load-timeout': 'éŸ³é¢‘åŠ è½½è¶…æ—¶ï¼Œè¯·é‡è¯•',
            'about-api': 'æœ‰å…³æ­¤ API',
            'pause': 'æš‚åœ',
            'play': 'æ’­æ”¾',
            'loading': 'åŠ è½½ä¸­...'
        },
        en: {
            title: 'MIDI Manager',
            'upload-midi': 'Upload MIDI',
            'search-songs': 'Search Songs',
            'latest-uploads': 'Latest Uploads',
            'message-board': 'Message Board',
            'upload': 'Upload',
            'uploader-name': 'Uploader Name',
            'delete-password': 'Delete Password',
            'upload-result': '',
            'search-placeholder': 'Song Name (supports fuzzy / * random)',
            'search': 'Search',
            'latest-uploads-header': 'Latest Uploads',
            'refresh': 'Refresh',
            'name': 'Name',
            'uploader': 'Uploader',
            'duration': 'Duration',
            'size': 'Size',
            'upload-time': 'Upload Time',
            'actions': 'Actions',
            'confidence': 'Confidence',
            'delete': 'Delete',
            'play': 'Play',
            'download': 'Download',
            'loading': 'Loading...',
            'no-more-data': 'No more data',
            'please-select-file': 'Please select MIDI file',
            'upload-success': 'Upload completed',
            'upload-failed': 'Upload failed, please try again',
            'please-enter-search': 'Please enter search keyword',
            'no-results': 'No results found',
            'search-failed': 'Search failed, please try again',
            'confirm-delete': 'Are you sure you want to delete this music file?',
            'please-enter-delete-password': 'Please enter delete password',
            'delete-success': 'Delete successful',
            'delete-failed': 'Delete failed, please try again',
            'message': 'Message',
            'nickname': 'Your Nickname',
            'message-content': 'Please enter your message',
            'submit-message': 'Submit Message',
            'refresh-comments': 'Refresh',
            'no-comments': 'No messages yet',
            'message-add-success': 'Message added successfully',
            'message-add-failed': 'Message add failed',
            'please-fill-message': 'Please fill in complete message information',
            'message-delete-success': 'Message deleted successfully',
            'message-delete-failed': 'Message delete failed',
            'confirm-delete-message': 'Are you sure you want to delete this message?',
            'now-playing': 'Now Playing',
            'close': 'Close',
            'generating-audio': 'Generating audio, please wait...',
            'start-playing': 'Start playing',
            'play-failed': 'Playback failed, please try again',
            'audio-load-failed': 'Audio load failed, please try again',
            'audio-load-timeout': 'Audio load timeout, please try again',
            'about-api': 'About this API',
            'pause': 'Pause',
            'play': 'Play',
            'loading': 'Loading...'
        },
        ja: {
            title: 'MIDI ç®¡ç†ãƒšãƒ¼ã‚¸',
            'upload-midi': 'MIDIã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰',
            'search-songs': 'æ›²ã‚’æ¤œç´¢',
            'latest-uploads': 'æœ€æ–°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰',
            'message-board': 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒ¼ãƒ‰',
            'upload': 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰',
            'uploader-name': 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼å',
            'delete-password': 'å‰Šé™¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰',
            'upload-result': '',
            'search-placeholder': 'æ›²åï¼ˆã‚ã„ã¾ã„æ¤œç´¢ / * ãƒ©ãƒ³ãƒ€ãƒ ï¼‰',
            'search': 'æ¤œç´¢',
            'latest-uploads-header': 'æœ€æ–°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰',
            'refresh': 'æ›´æ–°',
            'name': 'åå‰',
            'uploader': 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼',
            'duration': 'æ™‚é–“',
            'size': 'ã‚µã‚¤ã‚º',
            'upload-time': 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚é–“',
            'actions': 'æ“ä½œ',
            'confidence': 'ä¿¡é ¼åº¦',
            'delete': 'å‰Šé™¤',
            'play': 'è©¦è´',
            'download': 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
            'loading': 'èª­ã¿è¾¼ã¿ä¸­...',
            'no-more-data': 'ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“',
            'please-select-file': 'MIDIãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„',
            'upload-success': 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†',
            'upload-failed': 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ',
            'please-enter-search': 'æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
            'no-results': 'çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
            'search-failed': 'æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ',
            'confirm-delete': 'ã“ã®éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ',
            'please-enter-delete-password': 'å‰Šé™¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
            'delete-success': 'å‰Šé™¤æˆåŠŸ',
            'delete-failed': 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ',
            'message': 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
            'nickname': 'ã‚ãªãŸã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ',
            'message-content': 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
            'submit-message': 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡',
            'refresh-comments': 'æ›´æ–°',
            'no-comments': 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“',
            'message-add-success': 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ',
            'message-add-failed': 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ',
            'please-fill-message': 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æƒ…å ±ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„',
            'message-delete-success': 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ',
            'message-delete-failed': 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ',
            'confirm-delete-message': 'ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ',
            'now-playing': 'å†ç”Ÿä¸­',
            'close': 'é–‰ã˜ã‚‹',
            'generating-audio': 'éŸ³å£°ã‚’ç”Ÿæˆä¸­ã€ãŠå¾…ã¡ãã ã•ã„...',
            'start-playing': 'å†ç”Ÿé–‹å§‹',
            'play-failed': 'å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ',
            'audio-load-failed': 'éŸ³å£°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ',
            'audio-load-timeout': 'éŸ³å£°ã®èª­ã¿è¾¼ã¿ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ',
            'about-api': 'ã“ã®APIã«ã¤ã„ã¦',
            'pause': 'ä¸€æ™‚åœæ­¢',
            'play': 'å†ç”Ÿ',
            'loading': 'èª­ã¿è¾¼ã¿ä¸­...'
        },
        vi: {
            title: 'Trang Quáº£n lÃ½ MIDI',
            'upload-midi': 'Táº£i lÃªn MIDI',
            'search-songs': 'TÃ¬m kiáº¿m bÃ i hÃ¡t',
            'latest-uploads': 'Táº£i lÃªn má»›i nháº¥t',
            'message-board': 'Sá»• tin nháº¯n',
            'upload': 'Táº£i lÃªn',
            'uploader-name': 'TÃªn ngÆ°á»i táº£i lÃªn',
            'delete-password': 'Máº­t kháº©u xÃ³a',
            'upload-result': '',
            'search-placeholder': 'TÃªn bÃ i hÃ¡t (há»— trá»£ má» / * ngáº«u nhiÃªn)',
            'search': 'TÃ¬m kiáº¿m',
            'latest-uploads-header': 'Táº£i lÃªn má»›i nháº¥t',
            'refresh': 'LÃ m má»›i',
            'name': 'TÃªn',
            'uploader': 'NgÆ°á»i táº£i lÃªn',
            'duration': 'Thá»i lÆ°á»£ng',
            'size': 'KÃ­ch thÆ°á»›c',
            'upload-time': 'Thá»i gian táº£i lÃªn',
            'actions': 'HÃ nh Ä‘á»™ng',
            'confidence': 'Äá»™ tin cáº­y',
            'delete': 'XÃ³a',
            'play': 'Nghe thá»­',
            'download': 'Táº£i xuá»‘ng',
            'loading': 'Äang táº£i...',
            'no-more-data': 'KhÃ´ng cÃ²n dá»¯ liá»‡u',
            'please-select-file': 'Vui lÃ²ng chá»n tá»‡p MIDI',
            'upload-success': 'Táº£i lÃªn thÃ nh cÃ´ng',
            'upload-failed': 'Táº£i lÃªn tháº¥t báº¡i',
            'please-enter-search': 'Vui lÃ²ng nháº­p tá»« khÃ³a tÃ¬m kiáº¿m',
            'no-results': 'KhÃ´ng tÃ¬m tháº¥y káº¿t quáº£',
            'search-failed': 'TÃ¬m kiáº¿m tháº¥t báº¡i',
            'confirm-delete': 'Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a tá»‡p nháº¡c nÃ y?',
            'please-enter-delete-password': 'Vui lÃ²ng nháº­p máº­t kháº©u xÃ³a',
            'delete-success': 'XÃ³a thÃ nh cÃ´ng',
            'delete-failed': 'XÃ³a tháº¥t báº¡i',
            'message': 'Tin nháº¯n',
            'nickname': 'Biá»‡t danh cá»§a báº¡n',
            'message-content': 'Vui lÃ²ng nháº­p ná»™i dung tin nháº¯n',
            'submit-message': 'Gá»­i tin nháº¯n',
            'refresh-comments': 'LÃ m má»›i',
            'no-comments': 'ChÆ°a cÃ³ tin nháº¯n',
            'message-add-success': 'Tin nháº¯n Ä‘Ã£ Ä‘Æ°á»£c thÃªm',
            'message-add-failed': 'ThÃªm tin nháº¯n tháº¥t báº¡i',
            'please-fill-message': 'Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin tin nháº¯n',
            'message-delete-success': 'Tin nháº¯n Ä‘Ã£ Ä‘Æ°á»£c xÃ³a',
            'message-delete-failed': 'XÃ³a tin nháº¯n tháº¥t báº¡i',
            'confirm-delete-message': 'Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a tin nháº¯n nÃ y?',
            'now-playing': 'Äang phÃ¡t',
            'close': 'ÄÃ³ng',
            'generating-audio': 'Äang táº¡o Ã¢m thanh, vui lÃ²ng chá»...',
            'start-playing': 'Báº¯t Ä‘áº§u phÃ¡t',
            'play-failed': 'PhÃ¡t tháº¥t báº¡i',
            'audio-load-failed': 'Táº£i Ã¢m thanh tháº¥t báº¡i',
            'audio-load-timeout': 'Táº£i Ã¢m thanh háº¿t giá»',
            'about-api': 'Vá» API nÃ y',
            'pause': 'Táº¡m dá»«ng',
            'play': 'PhÃ¡t',
            'loading': 'Äang táº£i...'
        },
        ko: {
            title: 'MIDI ê´€ë¦¬ í˜ì´ì§€',
            'upload-midi': 'MIDI ì—…ë¡œë“œ',
            'search-songs': 'ë…¸ë˜ ê²€ìƒ‰',
            'latest-uploads': 'ìµœì‹  ì—…ë¡œë“œ',
            'message-board': 'ë©”ì‹œì§€ ë³´ë“œ',
            'upload': 'ì—…ë¡œë“œ',
            'uploader-name': 'ì—…ë¡œë” ì´ë¦„',
            'delete-password': 'ì‚­ì œ ë¹„ë°€ë²ˆí˜¸',
            'upload-result': '',
            'search-placeholder': 'ë…¸ë˜ ì´ë¦„ (ëª¨í˜¸ / * ëœë¤ ê²€ìƒ‰)',
            'search': 'ê²€ìƒ‰',
            'latest-uploads-header': 'ìµœì‹  ì—…ë¡œë“œ',
            'refresh': 'ìƒˆë¡œê³ ì¹¨',
            'name': 'ì´ë¦„',
            'uploader': 'ì—…ë¡œë”',
            'duration': 'ì‹œê°„',
            'size': 'í¬ê¸°',
            'upload-time': 'ì—…ë¡œë“œ ì‹œê°„',
            'actions': 'ì¡°ì‘',
            'confidence': 'ì‹ ë¢°ë„',
            'delete': 'ì‚­ì œ',
            'play': 'ë“£ê¸°',
            'download': 'ë‹¤ìš´ë¡œë“œ',
            'loading': 'ë¡œë”© ì¤‘...',
            'no-more-data': 'ë” ì´ìƒ ë°ì´í„° ì—†ìŒ',
            'please-select-file': 'MIDI íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”',
            'upload-success': 'ì—…ë¡œë“œ ì™„ë£Œ',
            'upload-failed': 'ì—…ë¡œë“œ ì‹¤íŒ¨',
            'please-enter-search': 'ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”',
            'no-results': 'ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ',
            'search-failed': 'ê²€ìƒ‰ ì‹¤íŒ¨',
            'confirm-delete': 'ì´ ìŒì•… íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
            'please-enter-delete-password': 'ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”',
            'delete-success': 'ì‚­ì œ ì„±ê³µ',
            'delete-failed': 'ì‚­ì œ ì‹¤íŒ¨',
            'message': 'ë©”ì‹œì§€',
            'nickname': 'ë‹‰ë„¤ì„',
            'message-content': 'ë©”ì‹œì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”',
            'submit-message': 'ë©”ì‹œì§€ ì „ì†¡',
            'refresh-comments': 'ìƒˆë¡œê³ ì¹¨',
            'no-comments': 'ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤',
            'message-add-success': 'ë©”ì‹œì§€ ì¶”ê°€ ì„±ê³µ',
            'message-add-failed': 'ë©”ì‹œì§€ ì¶”ê°€ ì‹¤íŒ¨',
            'please-fill-message': 'ë©”ì‹œì§€ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”',
            'message-delete-success': 'ë©”ì‹œì§€ ì‚­ì œ ì„±ê³µ',
            'message-delete-failed': 'ë©”ì‹œì§€ ì‚­ì œ ì‹¤íŒ¨',
            'confirm-delete-message': 'ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
            'now-playing': 'ì§€ê¸ˆ ì¬ìƒ ì¤‘',
            'close': 'ë‹«ê¸°',
            'generating-audio': 'ì˜¤ë””ì˜¤ ìƒì„± ì¤‘, ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...',
            'start-playing': 'ì¬ìƒ ì‹œì‘',
            'play-failed': 'ì¬ìƒ ì‹¤íŒ¨',
            'audio-load-failed': 'ì˜¤ë””ì˜¤ ë¡œë”© ì‹¤íŒ¨',
            'audio-load-timeout': 'ì˜¤ë””ì˜¤ ë¡œë”© ì‹œê°„ ì´ˆê³¼',
            'about-api': 'ì´ APIì— ëŒ€í•´',
            'pause': 'ì¼ì‹œì •ì§€',
            'play': 'ì¬ìƒ',
            'loading': 'ë¡œë”© ì¤‘...'
        }
    },

    // åˆå§‹åŒ–
    init() {
        // ä» localStorage æˆ–æµè§ˆå™¨è¯­è¨€è·å–
        const savedLang = localStorage.getItem('midi_app_lang');
        const browserLang = navigator.language || navigator.userLanguage;

        // æ£€æµ‹æµè§ˆå™¨è¯­è¨€
        if (!savedLang) {
            const langCode = browserLang.split('-')[0].toLowerCase();
            this.currentLang = this.supportedLangs.includes(langCode) ? langCode : 'en';
        } else {
            this.currentLang = savedLang;
        }

        this.updateLanguage();
        this.updateDropdownButtons();
    },

    // åˆ‡æ¢è¯­è¨€
    switch(lang) {
        if (!this.supportedLangs.includes(lang)) return;

        this.currentLang = lang;
        localStorage.setItem('midi_app_lang', lang);
        this.updateLanguage();
        this.updateDropdownButtons();
        this.updatePlayPauseText();
    },

    // è·å–ç¿»è¯‘æ–‡æœ¬
    t(key) {
        return this.translations[this.currentLang]?.[key] || key;
    },

    // æ›´æ–°é¡µé¢è¯­è¨€
    updateLanguage() {
        // æ›´æ–°æ ‡é¢˜
        document.title = this.t('title');

        // æ›´æ–°æœ‰ data-key å±æ€§çš„å…ƒç´ 
        document.querySelectorAll('[data-key]').forEach(element => {
            const key = element.getAttribute('data-key');
            if (this.t(key)) {
                // å¤„ç†è¡¨æ ¼æ ‡é¢˜
                if (element.tagName === 'TH') {
                    element.textContent = this.t(key);
                } else {
                    // å¤„ç†å…¶ä»–å…ƒç´ ï¼ŒåŒ…æ‹¬æŒ‰é’®
                    element.textContent = this.t(key);
                }
            }
        });


        // æ›´æ–°æœ‰ data-placeholder-key å±æ€§çš„å…ƒç´ 
        document.querySelectorAll('[data-placeholder-key]').forEach(element => {
            const key = element.getAttribute('data-placeholder-key');
            if (this.t(key)) {
                element.placeholder = this.t(key);
            }
        });

        // æ›´æ–°æ‰€æœ‰æ“ä½œæŒ‰é’®çš„ç¿»è¯‘ï¼ˆé‡æ–°åŠ è½½ç¿»è¯‘æ–‡æœ¬ï¼‰
        this.updateAllButtons();

        // æ›´æ–°å½“å‰è¯­è¨€æŒ‰é’®æ–‡æœ¬
        const langNames = {
            zh: 'ä¸­æ–‡',
            en: 'English',
            ja: 'æ—¥æœ¬èª',
            vi: 'Tiáº¿ng Viá»‡t',
            ko: 'í•œêµ­ì–´'
        };
        document.getElementById('currentLangBtn').textContent = `ğŸŒ ${langNames[this.currentLang]}`;
    },

    // æ›´æ–°æŒ‰é’®æ–‡æœ¬ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
    updateButtonText(key, originalText) {
        const buttons = document.querySelectorAll('button');
        buttons.forEach(button => {
            if (button.textContent.trim() === originalText) {
                button.textContent = this.t(key);
            }
        });
    },

    // æ›´æ–°è¾“å…¥æ¡†å ä½ç¬¦
    updatePlaceholder(key, originalText) {
        const input = document.querySelector(`input[placeholder*="${originalText.split(' ')[0]}"], textarea[placeholder*="${originalText.split(' ')[0]}"]`);
        if (input) {
            input.placeholder = this.t(key);
        }
    },

    // æ›´æ–°æ–‡æœ¬å†…å®¹
    updateText(key, originalText) {
        const elements = document.querySelectorAll(`th:contains("${originalText}")`);
        elements.forEach(element => {
            element.textContent = this.t(key);
        });
    },

    // æ›´æ–°ä¸‹æ‹‰æŒ‰é’®çŠ¶æ€
    updateDropdownButtons() {
        const buttons = document.querySelectorAll('.language-dropdown button');
        buttons.forEach(button => {
            button.classList.remove('active');
            if (button.textContent.includes(this.getLangName(this.currentLang))) {
                button.classList.add('active');
            }
        });
    },

    // è·å–è¯­è¨€åç§°
    getLangName(lang) {
        const names = {
            zh: 'ä¸­æ–‡',
            en: 'English',
            ja: 'æ—¥æœ¬èª',
            vi: 'Tiáº¿ng Viá»‡t',
            ko: 'í•œêµ­ì–´'
        };
        return names[lang];
    },

    // æ˜¾ç¤º/éšè—ä¸‹æ‹‰èœå•
    showDropdown() {
        const dropdown = document.getElementById('languageDropdown');
        dropdown.classList.toggle('show');

        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        setTimeout(() => {
            document.addEventListener('click', this.hideDropdown.bind(this));
        }, 100);
    },

    hideDropdown(event) {
        if (!event.target.closest('.language-switcher')) {
            document.getElementById('languageDropdown').classList.remove('show');
            document.removeEventListener('click', this.hideDropdown.bind(this));
        }
    },

    // æ›´æ–°æ’­æ”¾/æš‚åœæŒ‰é’®æ–‡æœ¬
    updatePlayPauseText() {
        const playPauseButton = document.getElementById('playPauseButton');
        if (playPauseButton && !playPauseButton.disabled) {
            const isPlaying = !audioPlayer.audio.paused;
            playPauseButton.textContent = isPlaying ? this.t('pause') : this.t('play');
        }
    },

    // æ›´æ–°æ‰€æœ‰æ“ä½œæŒ‰é’®çš„ç¿»è¯‘
    updateAllButtons() {
        // æ›´æ–°æ‰€æœ‰æœ‰ data-key çš„æŒ‰é’®
        document.querySelectorAll('button[data-key]').forEach(button => {
            const key = button.getAttribute('data-key');
            if (this.t(key)) {
                button.textContent = this.t(key);
            }
        });
    }
};

// ä½¿ç”¨IIFEå°è£…åº”ç”¨ï¼Œå‡å°‘å…¨å±€å˜é‡
(() => {
    const API_BASE = `${location.protocol}//${location.hostname}:1200`;
    
    // åº”ç”¨çŠ¶æ€
    const state = {
        currentPage: 1,
        pageSize: 50,
        isLoading: false,
        isEnd: false,
        isAdmin: false, // ç®¡ç†å‘˜çŠ¶æ€
        routeAdmin: null // è·¯ç”±å‚æ•°ä¸­çš„ç®¡ç†å‘˜å¯†ç 
    };

    // è§£æURLä¸­çš„è·¯ç”±å‚æ•°
    const parseUrlParams = () => {
        const urlParams = new URLSearchParams(window.location.search);
        state.routeAdmin = urlParams.get('admin');
        if (state.routeAdmin) {
            state.isAdmin = true; // å¦‚æœæœ‰ç®¡ç†å‘˜å‚æ•°ï¼Œè®¾ç½®ä¸ºç®¡ç†å‘˜çŠ¶æ€
        }
    };

    // DOMå…ƒç´ ç¼“å­˜
    const elements = {
        fileInput: document.getElementById('file'),
        uploadByInput: document.getElementById('upload_by'),
        deletePasswordInput: document.getElementById('delete_password'),
        uploadResult: document.getElementById('upload_result'),
        searchNameInput: document.getElementById('search_name'),
        searchResults: document.getElementById('search_results'),
        latestList: document.getElementById('latest_list'),
        loadingIndicator: document.getElementById('loading'),
        endIndicator: document.getElementById('end'),
        tableContainer: document.getElementById('table_container'),
        commentNameInput: document.getElementById('comment_name'),
        commentContentInput: document.getElementById('comment_content'),
        commentsList: document.getElementById('comments_list')
    };

    // å·¥å…·å‡½æ•°
    const utils = {
        // é˜²æŠ–å‡½æ•°
        debounce(fn, wait) {
            let timeout = null;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), wait);
            };
        },

        // XSSé˜²æŠ¤
        escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        },

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },

        // æ ¼å¼åŒ–æ—¶é•¿
        formatDuration(ms) {
            if (!ms) return '-';
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        },
        
        // æ ¼å¼åŒ–ä¸Šä¼ æ—¶é—´
        formatUploadTime(timeStr) {
            if (!timeStr) return '-';
            try {
                const date = new Date(timeStr);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return timeStr;
            }
        },
        
        // é€šç”¨æç¤ºå‡½æ•°
        showMessage(message, type = 'info') {
            // å¦‚æœæ¶ˆæ¯æ˜¯ç¿»è¯‘é”®ï¼Œåˆ™ç¿»è¯‘å®ƒ
            let displayMessage = message;
            if (message.startsWith('t-')) {
                const key = message.substring(2);
                displayMessage = language.t(key);
            }

            const msg = document.createElement('div');
            msg.textContent = displayMessage;
            
            // æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒé¢œè‰²
            const colors = {
                info: '#2196F3',
                success: '#4CAF50',
                error: '#f44336',
                warning: '#ff9800'
            };
            
            msg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 10px 15px;
                border-radius: 4px;
                z-index: 1000;
                font-size: 14px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            `;
            
            document.body.appendChild(msg);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤æç¤º
            setTimeout(() => msg.remove(), 3000);
        },
        
        // è·å–æˆ–ç”Ÿæˆè®¾å¤‡å”¯ä¸€æ ‡è¯†ç¬¦
        getDeviceId() {
            // å°è¯•ä»localStorageè·å–è®¾å¤‡ID
            let deviceId = localStorage.getItem('midi_app_device_id');
            
            // å¦‚æœä¸å­˜åœ¨ï¼Œç”Ÿæˆæ–°çš„è®¾å¤‡ID
            if (!deviceId) {
                // ä½¿ç”¨æ—¶é—´æˆ³å’Œéšæœºæ•°ç”Ÿæˆå”¯ä¸€ID
                deviceId = 'dev_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
                // å­˜å‚¨åˆ°localStorage
                localStorage.setItem('midi_app_device_id', deviceId);
            }
            
            return deviceId;
        }
    };

    // æ ‡ç­¾é¡µç®¡ç†
    const tabs = {
        switchTab(tabId, event) {
            // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-nav button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // æ›´æ–°å†…å®¹é¢æ¿æ˜¾ç¤º
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            // å½“åˆ‡æ¢åˆ°ç•™è¨€æ ‡ç­¾é¡µæ—¶ï¼ŒåŠ è½½ç•™è¨€åˆ—è¡¨
            if (tabId === 'comments') {
                comments.loadComments();
            }
        }
    };

    // æœ€æ–°ä¸Šä¼ ç®¡ç†
    const songList = {
        // åŠ è½½æœ€æ–°ä¸Šä¼ 
        async loadLatest(page = 1, append = false) {
            if (state.isLoading || (state.isEnd && append)) return;

            state.isLoading = true;
            elements.loadingIndicator.style.display = 'block';
            elements.endIndicator.style.display = 'none';

            try {
                const res = await fetch(`${API_BASE}/latest_songs?page=${page}&page_size=${state.pageSize}`);
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }
                const data = await res.json();

                if (!append) {
                    elements.latestList.innerHTML = '';
                }

                const items = data.midis || data.results || [];

                items.forEach(song => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${utils.escapeHtml(song.name)}</td>
                        <td>${utils.escapeHtml(song.upload_by || '')}</td>
                        <td>${utils.formatDuration(song.duration)}</td>
                        <td>${utils.formatFileSize(song.file_size)}</td>
                        <td>${utils.formatUploadTime(song.upload_time)}</td>
                        <td>${songList.formatActions(song)}</td>
                    `;
                    elements.latestList.appendChild(tr);
                });

                // å¦‚æœæœ¬æ¬¡è¿”å›çš„æ•°æ®å°‘äº pageSizeï¼Œåˆ™è®¤ä¸ºå·²åˆ°æœ«å°¾
                if (items.length < state.pageSize) {
                    state.isEnd = true;
                    elements.endIndicator.style.display = items.length === 0 && !append ? 'none' : 'block';
                } else {
                    state.isEnd = false;
                }

                state.currentPage = page;
            } catch (err) {
                console.error('åŠ è½½å¤±è´¥', err);
                utils.showMessage('t-delete-failed', 'error');
            } finally {
                state.isLoading = false;
                elements.loadingIndicator.style.display = 'none';
            }
        },

        // åˆ·æ–°åˆ—è¡¨
        refreshList() {
            state.currentPage = 1;
            state.isEnd = false;
            songList.loadLatest(1, false);
        },

        // æ ¼å¼åŒ–æ“ä½œæŒ‰é’®
        formatActions(song) {
            const deleteBtn = language.t('delete');
            const playBtn = language.t('play');
            const downloadBtn = language.t('download');

            return `
                <div class="actions">
                    <button onclick="midiApp.deleteSong('${song.hash}')" data-key="delete">${deleteBtn}</button>
                    <button class="play" onclick="midiApp.playAudio('${song.hash}')" data-key="play">${playBtn}</button>
                    <button onclick="midiApp.download('${song.hash}')" data-key="download">${downloadBtn}</button>
                </div>
            `;
        },

        // æ»šåŠ¨åŠ è½½
        setupScrollLoad() {
            const onScroll = utils.debounce(() => {
                if (state.isLoading || state.isEnd) return;

                // æ£€æµ‹æ¥è¿‘åº•éƒ¨ï¼ˆå‰©ä½™ 80px æ—¶è§¦å‘ï¼‰
                const { scrollTop, clientHeight, scrollHeight } = elements.tableContainer;
                if (scrollTop + clientHeight >= scrollHeight - 80) {
                    songList.loadLatest(state.currentPage + 1, true);
                }
            }, 150);

            elements.tableContainer.addEventListener('scroll', onScroll);
        }
    };

    // ä¸Šä¼ åŠŸèƒ½
    const upload = {
        async handleUpload() {
            const file = elements.fileInput.files[0];
            const uploadBy = elements.uploadByInput.value;
            const deletePassword = elements.deletePasswordInput.value;

            if (!file) {
                utils.showMessage('t-please-select-file', 'warning');
                return;
            }

            const form = new FormData();
            form.append('file', file);
            form.append('upload_by', uploadBy);
            form.append('delete_password', deletePassword);

            try {
                const res = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: form
                });

                const data = await res.json();
                
                // ä½¿ç”¨é€šç”¨æç¤ºå‡½æ•°
                utils.showMessage(data.message || 't-upload-success', 'success');
                
                // é‡ç½®è¡¨å•
                document.getElementById('upload-form').reset();
                
                // æ¸…ç©ºåŸæœ‰çš„æç¤º
                elements.uploadResult.innerText = '';
                
                // åˆ·æ–°åˆ—è¡¨
                songList.refreshList();
            } catch (err) {
                console.error('ä¸Šä¼ å¤±è´¥', err);
                utils.showMessage('t-upload-failed', 'error');
                elements.uploadResult.innerText = '';
            }
        }
    };

    // æœç´¢åŠŸèƒ½
    const search = {
        async handleSearch() {
            const name = elements.searchNameInput.value;
            if (!name.trim()) {
                utils.showMessage('t-please-enter-search', 'warning');
                elements.searchResults.innerHTML = '';
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/search?name=${encodeURIComponent(name)}`);
                const data = await res.json();

                if (!data.results || data.results.length === 0) {
                    utils.showMessage('t-no-results', 'info');
                    elements.searchResults.innerHTML = '';
                    return;
                }

                let html = `
                    <div class="table-container" style="max-height:300px;">
                    <table>
                        <thead>
                            <tr>
                                <th data-key="name">åç§°</th>
                                <th data-key="uploader">ä¸Šä¼ è€…</th>
                                <th data-key="confidence">ç½®ä¿¡åº¦</th>
                                <th data-key="upload-time">ä¸Šä¼ æ—¶é—´</th>
                                <th data-key="actions">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.results.forEach(song => {
                    html += `
                        <tr>
                            <td>${utils.escapeHtml(song.name)}</td>
                            <td>${utils.escapeHtml(song.upload_by || '')}</td>
                            <td>${song.confidence ? (song.confidence * 100).toFixed(1) + '%' : '-'}</td>
                            <td>${utils.formatUploadTime(song.upload_time)}</td>
                            <td>${songList.formatActions(song)}</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                    </div>
                `;

                elements.searchResults.innerHTML = html;

                // æ›´æ–°æœç´¢ç»“æœè¡¨æ ¼çš„è¯­è¨€
                language.updateLanguage();
            } catch (err) {
                console.error('æœç´¢å¤±è´¥', err);
                utils.showMessage('t-search-failed', 'error');
                elements.searchResults.innerHTML = '';
            }
        }
    };

    // æ­Œæ›²æ“ä½œ
    const songActions = {
        // ä¸‹è½½æ­Œæ›²
        download(hash) {
            window.open(`${API_BASE}/download?hash=${encodeURIComponent(hash)}`, '_blank');
        },

        // åˆ é™¤æ­Œæ›²
        async deleteSong(hash) {
            let pwd = '';
            // ç®¡ç†å‘˜æ¨¡å¼ä¸‹ä¸éœ€è¦è¾“å…¥å¯†ç 
            if (state.isAdmin) {
                const confirmDelete = confirm(language.t('confirm-delete'));
                if (!confirmDelete) return;
            } else {
                pwd = prompt(language.t('please-enter-delete-password'));
                if (!pwd) return;
            }

            const form = new FormData();
            form.append('hash', hash);
            form.append('delete_password', state.isAdmin ? '' : pwd);
            
            // å¦‚æœæ˜¯ç®¡ç†å‘˜çŠ¶æ€ï¼Œä¼ é€’å¯†ç å‚æ•°
            if (state.isAdmin && state.routeAdmin) {
                form.append('admin_password', state.routeAdmin);
            }

            try {
                const res = await fetch(`${API_BASE}/delete${state.routeAdmin ? `?admin=${encodeURIComponent(state.routeAdmin)}` : ''}`, {
                    method: 'POST',
                    body: form
                });

                const data = await res.json();

                // ä½¿ç”¨é€šç”¨æç¤ºå‡½æ•°
                utils.showMessage(data.message || language.t('delete-success'), 'success');
                
                // åˆ·æ–°åˆ—è¡¨
                songList.refreshList();
            } catch (err) {
                console.error('åˆ é™¤å¤±è´¥', err);
                utils.showMessage('t-delete-failed', 'error');
            }
        }
    };
    
    // ç•™è¨€åŠŸèƒ½
    const comments = {
        // æ·»åŠ ç•™è¨€
        async addComment() {
            const name = elements.commentNameInput.value;
            const content = elements.commentContentInput.value;
            
            if (!name.trim() || !content.trim()) {
                utils.showMessage('t-please-fill-message', 'warning');
                return;
            }
            
            const form = new FormData();
            form.append('name', name);
            form.append('content', content);
            form.append('device_id', utils.getDeviceId());
            
            try {
                const res = await fetch(`${API_BASE}/add_comment`, {
                    method: 'POST',
                    body: form
                });
                
                const data = await res.json();
                
                if (data.succeed) {
                    utils.showMessage('t-message-add-success', 'success');

                    // é‡ç½®è¡¨å•
                    document.getElementById('comment-form').reset();

                    // åˆ·æ–°ç•™è¨€åˆ—è¡¨
                    comments.loadComments();
                } else {
                    utils.showMessage(data.message || 't-message-add-failed', 'error');
                }
            } catch (err) {
                console.error('æ·»åŠ ç•™è¨€å¤±è´¥', err);
                utils.showMessage('t-message-add-failed', 'error');
            }
        },
        
        // åŠ è½½ç•™è¨€åˆ—è¡¨
        async loadComments() {
            try {
                const res = await fetch(`${API_BASE}/comments`);
                const data = await res.json();
                
                if (data.succeed) {
                    comments.renderComments(data.comments);
                } else {
                    utils.showMessage(data.message || 't-message-add-failed', 'error');
                }
            } catch (err) {
                console.error('åŠ è½½ç•™è¨€å¤±è´¥', err);
                utils.showMessage('t-message-add-failed', 'error');
            }
        },
        
        // æ¸²æŸ“ç•™è¨€åˆ—è¡¨
        renderComments(commentsList) {
            if (!commentsList || commentsList.length === 0) {
                elements.commentsList.innerHTML = `<p class="small" style="text-align: center;">${language.t('t-no-comments')}</p>`;
                return;
            }
            
            const currentDeviceId = utils.getDeviceId();
            let html = '';
            commentsList.forEach(comment => {
                // æ ¼å¼åŒ–æ—¶é—´
                const formattedTime = utils.formatUploadTime(comment.created_at);
                
                // ç®¡ç†å‘˜æˆ–å½“å‰è®¾å¤‡çš„ç•™è¨€æ‰æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                const showDelete = state.isAdmin || comment.device_id === currentDeviceId;
                const deleteButton = showDelete ? `
                    <div class="comment-actions">
                        <button onclick="midiApp.deleteComment('${comment.id}')">åˆ é™¤</button>
                    </div>
                ` : '';
                
                html += `
                    <div class="comment-item">
                        <div class="comment-header">
                            <span class="comment-author">${utils.escapeHtml(comment.name)}</span>
                            <span class="comment-time">${formattedTime}</span>
                        </div>
                        <div class="comment-content">${utils.escapeHtml(comment.content)}</div>
                        ${deleteButton}
                    </div>
                `;
            });
            
            elements.commentsList.innerHTML = html;
        },
        
        // åˆ é™¤ç•™è¨€
        async deleteComment(commentId) {
            if (!confirm(language.t('confirm-delete-message'))) return;
            
            const form = new FormData();
            form.append('comment_id', commentId);
            form.append('device_id', utils.getDeviceId());
            
            // å¦‚æœæ˜¯ç®¡ç†å‘˜çŠ¶æ€ï¼Œä¼ é€’å¯†ç å‚æ•°
            if (state.isAdmin && state.routeAdmin) {
                form.append('admin_password', state.routeAdmin);
            }
            
            try {
                const res = await fetch(`${API_BASE}/delete_comment${state.routeAdmin ? `?admin=${encodeURIComponent(state.routeAdmin)}` : ''}`, {
                    method: 'POST',
                    body: form
                });
                
                const data = await res.json();
                
                if (data.succeed) {
                    utils.showMessage('t-message-delete-success', 'success');
                    comments.loadComments();
                } else {
                    utils.showMessage(data.message || 't-message-delete-failed', 'error');
                }
            } catch (err) {
                console.error('åˆ é™¤ç•™è¨€å¤±è´¥', err);
                utils.showMessage('t-message-delete-failed', 'error');
            }
        }
    };

    // éŸ³é¢‘æ’­æ”¾å™¨
    const audioPlayer = {
        audio: document.getElementById('audioElement'),
        progressBar: document.getElementById('progressBar'),
        progressContainer: document.getElementById('progressContainer'),
        currentTimeEl: document.getElementById('currentTime'),
        durationEl: document.getElementById('duration'),
        playPauseButton: document.getElementById('playPauseButton'),
        playerTitle: document.getElementById('playerTitle'),
        audioPlayer: document.getElementById('audioPlayer'),
        waitingPlayer: document.getElementById('waitingPlayer'),
        playerOverlay: document.getElementById('playerOverlay'),
        isDragging: false, // æ·»åŠ æ‹–åŠ¨çŠ¶æ€æ ‡å¿—
        timeout: null, // è¶…æ—¶å¤„ç†
        handleLoadedMetadata: null, // äº‹ä»¶å¤„ç†å™¨
        handleCanPlay: null, // äº‹ä»¶å¤„ç†å™¨
        handleError: null, // äº‹ä»¶å¤„ç†å™¨

        init() {
            this.audio.addEventListener('timeupdate', () => this.updateProgress());
            this.audio.addEventListener('loadedmetadata', () => this.updateDuration());
            this.audio.addEventListener('ended', () => this.onEnded());
            // æ·»åŠ é”™è¯¯å¤„ç†ï¼Œåœ¨éŸ³é¢‘åŠ è½½å¤±è´¥æ—¶ä¹Ÿèƒ½æ­£ç¡®æ˜¾ç¤º
            this.audio.addEventListener('error', () => {
                this.updateDuration();
            });

            // ç‚¹å‡»äº‹ä»¶
            this.progressContainer.addEventListener('click', (e) => this.seek(e));
            
            // æ‹–åŠ¨åŠŸèƒ½
            this.setupDrag();
        },

        playAudio(hash) {
            const url = `http://139.196.113.128:1220/wav?hash=${encodeURIComponent(hash)}`;
            this.playerTitle.textContent = `${language.t('now-playing')}: ${hash.substring(0, 8)}...`;

            // æ˜¾ç¤ºç­‰å¾…æç¤º
            this.showWaiting();

            // é‡ç½®éŸ³é¢‘å…ƒç´ 
            this.audio.src = '';
            this.isDragging = false;
            
            // è®¾ç½®éŸ³é¢‘æº - é’ˆå¯¹AACæ ¼å¼ä¼˜åŒ–
            this.audio.src = url;
            this.audio.preload = 'metadata';
            // å¯¹äºAACæµï¼Œå¯èƒ½éœ€è¦è®¾ç½®ä¸€äº›é¢å¤–å±æ€§
            this.audio.crossOrigin = 'anonymous';

            // æ¸…ç†ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
            this.audio.removeEventListener('loadedmetadata', this.handleLoadedMetadata);
            this.audio.removeEventListener('canplay', this.handleCanPlay);
            this.audio.removeEventListener('error', this.handleError);

            // å®šä¹‰äº‹ä»¶å¤„ç†å™¨
            this.handleLoadedMetadata = () => {
                this.showPlayer();
                this.updateDuration();
                console.log('éŸ³é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆï¼Œæ—¶é•¿:', this.audio.duration);
            };

            this.handleCanPlay = () => {
                clearTimeout(this.timeout);
                this.audio.play().then(() => {
                    this.playPauseButton.textContent = language.t('pause');
                    utils.showMessage('t-start-playing', 'success');
                }).catch(err => {
                    console.error('æ’­æ”¾å¤±è´¥:', err);
                    utils.showMessage('t-play-failed', 'error');
                    this.close();
                });
            };

            this.handleError = (e) => {
                clearTimeout(this.timeout);
                console.error('éŸ³é¢‘åŠ è½½é”™è¯¯:', e);
                utils.showMessage('t-audio-load-failed', 'error');
                this.close();
            };

            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            this.audio.addEventListener('loadedmetadata', this.handleLoadedMetadata, { once: true });
            this.audio.addEventListener('canplay', this.handleCanPlay, { once: true });
            this.audio.addEventListener('error', this.handleError, { once: true });

            // è®¾ç½®è¶…æ—¶å¤„ç†
            this.timeout = setTimeout(() => {
                utils.showMessage('t-audio-load-timeout', 'error');
                this.close();
            }, 15000);

            // å¼€å§‹åŠ è½½
            this.audio.load();
        },

        showWaiting() {
            this.waitingPlayer.classList.add('active');
            this.playerOverlay.classList.add('active');
        },

        showPlayer() {
            this.waitingPlayer.classList.remove('active');
            this.audioPlayer.classList.add('active');
            this.playPauseButton.textContent = 'æ’­æ”¾';
            this.playPauseButton.disabled = false;
        },

        close() {
            // æ¸…ç†è¶…æ—¶
            if (this.timeout) {
                clearTimeout(this.timeout);
                this.timeout = null;
            }
            
            // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
            if (this.handleLoadedMetadata) {
                this.audio.removeEventListener('loadedmetadata', this.handleLoadedMetadata);
                this.handleLoadedMetadata = null;
            }
            if (this.handleCanPlay) {
                this.audio.removeEventListener('canplay', this.handleCanPlay);
                this.handleCanPlay = null;
            }
            if (this.handleError) {
                this.audio.removeEventListener('error', this.handleError);
                this.handleError = null;
            }
            
            // é‡ç½®UIçŠ¶æ€
            this.audioPlayer.classList.remove('active');
            this.waitingPlayer.classList.remove('active');
            this.playerOverlay.classList.remove('active');
            this.audio.pause();
            this.audio.src = '';
            this.isDragging = false;
            this.playPauseButton.textContent = 'æ’­æ”¾';
            this.playPauseButton.disabled = true;
            this.progressBar.style.width = '0%';
            this.currentTimeEl.textContent = '0:00';
        },

        togglePlayPause() {
            if (this.audio.paused) {
                this.audio.play();
            } else {
                this.audio.pause();
            }
            language.updatePlayPauseText();
        },

        updateProgress() {
            // å¦‚æœæ­£åœ¨æ‹–åŠ¨ï¼Œä¸æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤º
            if (this.isDragging) {
                return;
            }
            
            // æ£€æŸ¥éŸ³é¢‘æ—¶é•¿æ˜¯å¦æœ‰æ•ˆ
            if (isNaN(this.audio.duration) || !isFinite(this.audio.duration)) {
                return;
            }

            const currentTime = this.audio.currentTime;
            const duration = this.audio.duration;
            const percent = (currentTime / duration) * 100;
            
            // æ›´æ–°è¿›åº¦æ¡
            this.progressBar.style.width = percent + '%';
            this.currentTimeEl.textContent = this.formatTime(currentTime);
            
            // è°ƒè¯•ä¿¡æ¯ï¼ˆä»…åœ¨å¼€å‘æ—¶ä½¿ç”¨ï¼‰
            if (Math.random() < 0.01) { // åªè¾“å‡º1%çš„æ—¥å¿—ï¼Œé¿å…åˆ·å±
                console.log('æ’­æ”¾è¿›åº¦:', currentTime, '/', duration, '(', percent.toFixed(2) + '%)');
            }
        },

        updateDuration() {
            // æ£€æŸ¥ duration æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
            if (isNaN(this.audio.duration) || !isFinite(this.audio.duration)) {
                this.durationEl.textContent = '0:00';
            } else {
                this.durationEl.textContent = this.formatTime(this.audio.duration);
            }
        },

        seek(e) {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡å’Œé»˜è®¤è¡Œä¸º
            e.preventDefault();
            e.stopPropagation();
            
            const rect = this.progressContainer.getBoundingClientRect();
            const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));

            // æ£€æŸ¥ audio.duration æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
            if (isNaN(this.audio.duration) || !isFinite(this.audio.duration)) {
                console.warn('éŸ³é¢‘æ—¶é•¿æ— æ•ˆ:', this.audio.duration);
                return;
            }

            const time = percent * this.audio.duration;
            // æ£€æŸ¥è®¡ç®—å‡ºçš„ time æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
            if (isFinite(time)) {
                console.log('è®¾ç½®æ’­æ”¾æ—¶é—´:', time, 'ç™¾åˆ†æ¯”:', percent);
                try {
                    this.audio.currentTime = time;
                    // ç«‹å³æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤º
                    this.progressBar.style.width = (percent * 100) + '%';
                    this.currentTimeEl.textContent = this.formatTime(time);
                } catch (err) {
                    console.error('è®¾ç½®æ’­æ”¾æ—¶é—´å¤±è´¥:', err);
                }
            }
        },



        formatTime(seconds) {
            // å¤„ç†å„ç§æ— æ•ˆå€¼æƒ…å†µ
            if (isNaN(seconds) || !isFinite(seconds) || seconds < 0) {
                return '0:00';
            }

            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        },

        setupDrag() {
            let isDragging = false;
            
            const startDrag = (e) => {
                isDragging = true;
                this.isDragging = true; // è®¾ç½®å®ä¾‹å±æ€§
                this.progressContainer.style.cursor = 'grabbing';
                this.progressBar.classList.add('dragging');
                this.seek(e);
            };
            
            const drag = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                this.seek(e);
            };
            
            const endDrag = () => {
                isDragging = false;
                this.isDragging = false; // æ¸…é™¤å®ä¾‹å±æ€§
                this.progressContainer.style.cursor = 'pointer';
                this.progressBar.classList.remove('dragging');
            };
            
            // é¼ æ ‡äº‹ä»¶
            this.progressContainer.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);
            
            // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨è®¾å¤‡æ”¯æŒï¼‰
            this.progressContainer.addEventListener('touchstart', (e) => {
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                startDrag(mouseEvent);
            });
            
            document.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                drag(mouseEvent);
            });
            
            document.addEventListener('touchend', endDrag);
        },

        onEnded() {
            this.playPauseButton.textContent = language.t('play');
            this.progressBar.style.width = '0%';
            this.currentTimeEl.textContent = '0:00';
        }
    };

    // åˆå§‹åŒ–åº”ç”¨
    const init = () => {
        // è§£æè·¯ç”±å‚æ•°
        parseUrlParams();

        // åˆå§‹åŒ–è¯­è¨€ç³»ç»Ÿ
        language.init();

        // è®¾ç½®æ»šåŠ¨åŠ è½½
        songList.setupScrollLoad();

        // åˆå§‹åŒ–éŸ³é¢‘æ’­æ”¾å™¨
        audioPlayer.init();

        // é¦–æ¬¡åŠ è½½æœ€æ–°ä¸Šä¼ 
        songList.loadLatest(1, false);
    };

    // æš´éœ²å…¨å±€APIï¼ˆä»…ç”¨äºæŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼‰
    window.midiApp = {
        switchTab: tabs.switchTab,
        upload: upload.handleUpload,
        search: search.handleSearch,
        refreshList: songList.refreshList,
        download: songActions.download,
        deleteSong: songActions.deleteSong,
        playAudio: audioPlayer.playAudio.bind(audioPlayer),
        addComment: comments.addComment,
        loadComments: comments.loadComments,
        deleteComment: comments.deleteComment
    };

    // æš´éœ²éŸ³é¢‘æ’­æ”¾å™¨å‡½æ•°åˆ°å…¨å±€
    window.audioPlayer = {
        togglePlayPause: audioPlayer.togglePlayPause.bind(audioPlayer),
        close: audioPlayer.close.bind(audioPlayer)
    };

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
